#!/usr/bin/env Rscript
source(glue::glue(Sys.getenv("BASE_DIR"), '/lib/utilities.R'))
source(glue::glue(Sys.getenv("BASE_DIR"), '/lib/imc_utils.R'))
source(glue::glue(Sys.getenv("BASE_DIR"), '/conf/settings.R'))
source(glue::glue(Sys.getenv("BASE_DIR"), '/lib/celltype_tree_utils.R'))
		
library(tidyr)
library(ggplot2)
library(data.table)
library(plyr)

arg_parser=argparser::arg_parser("Summarize typing results")
add=argparser::add_argument
arg_parser=add(arg_parser, arg="--regFile", 
		default='data/sample_file.txt',
        help='File with image annotations')
arg_parser=add(arg_parser, arg="--wDir", help="output")
arg_parser=add(arg_parser, arg="--cellReviewDir", 
	help=paste("review"))
arg_parser=add(arg_parser, arg="--subset", 
	default="major", help='major/sampled')
arg_parser=add(arg_parser, arg="--panel",
	 default='p1', help="Panel of markers")
arg_parser=add(arg_parser, arg="--major_method",
	 default="cellassign", help="")
arg_parser=add(arg_parser, arg="--major_markers", 
	default="major_markers", help="")
arg_parser=add(arg_parser, "--mostFreqCellType",
	default='None', help="file or NULL")
args=argparser::parse_args(arg_parser, 
	argv=commandArgs(trailingOnly=TRUE))
args = c(args, pars)

methods = c(args$major_method ,"csm")
features = c('area', 'meanIntensity', 'probability')
cellTypePattern = ".clusters.txt"

csmCol = f("cellType_csm_{args$major_markers}")
regionCol = f("region_{args$major_method}_{args$major_markers}")
print(f("Most frequent cell type {args$mostFreqCellType}"))

# I/O
out = f("{args$wDir}/review/{args$panel}_{args$major_markers}")
analysisID = with(args, f("{panel}_{major_markers}"))
modelOut = with(args, f("{cellReviewDir}/{analysisID}.RData"))
log=f("{out}/{analysisID}.log")

if(! dir.exists(out))
	dir.create(out, recursive = T)

cat('Stratification by confidence', file = log, append = F)

if(args$mostFreqCellType == 'None') {
	# get the most freq from the full model
	fullPath = analysisPath %>%
		gsub('markers', 'major_markers', .) %>%
		gsub('method', 'major_method', .)
	fullModelDir = file.path(args$wDir, with(args, f(fullPath)))
	fullModelID=paste0(args[[args$major_method]], collapse="_")
	fullModelFile=f("{fullModelDir}/{fullModelID}.clusters.fst")
	if(! file.exists(fullModelFile))
		stop('The complete model hasnt been built', fullModelFile)
	fullData=fst::read.fst(fullModelFile)
	cellStats=table(fullData$cellType)
	args$mostFreqCellType = names(cellStats)[cellStats == max(cellStats)]
	if(args$mostFreqCellType == 'Smooth muscle cells')
		args$dependentCell = 'aSMA+ cells'
	print(f("Most frequent cell type {args$mostFreqCellType}"))
} else {
	cat('The most frequent cell type is provided by the user', 
		args$mostFreqCellType, '\n')
	cat('The most frequent cell type is provided by the user', 
		args$mostFreqCellType, '\n', file = log, append = T)
}
excludedMarkers = get_celltype_markers(marker_gene_list[[args$major_markers]], args$mostFreqCellType)
majorTree = get_node_list(marker_gene_list[[args$major_markers]])
print(excludedMarkers)
dependentCellTypes = sapply(names(majorTree), function(x) any(excludedMarkers %in% majorTree[[x]])) 
dependentCellTypes = setdiff(names(dependentCellTypes)[dependentCellTypes], args$mostFreqCellType)

abrv = strsplit(args$mostFreqCellType, split = '')[[1]][1:3] %>% 
		tolower %>% paste0(., collapse = "")
ref_markers_list = paste1(args$major_markers, abrv)
markerSets = c(args$major_markers, ref_markers_list)

typedCols = sapply(markerSets,
	function(marker) f("cellType_{args$major_method}_{marker}"))

intensityColNameFull = f("meanIntensity_{args$major_method}_{args$major_markers}")
intensityColNameRef = f("meanIntensity_{args$major_method}_{ref_markers_list}")

data=vector(mode="list")

for(markers in markerSets) {
  for(method in methods) {
    wdir=f("{args$wDir}/", with(args, f(analysisPath)))
    if(method == "csm" & length(grep(method, names(data)))) 
		next
    revFile=list.files(wdir, pattern=cellTypePattern, full.names = T)
    if(! length(revFile))
		next
	print(revFile)

#    tmp=fst::read_fst(revFile)
	tmp = data.table::fread(revFile)
    cat(markers, method, wdir, length(unique(tmp$imagename)), '\n')
	if(method == "csm")
		tmp$positive=tmp$names
	
	# Only keep CD3+CD4+ T cells as a positive control for CD4 T cells
    tmp$CD3 = get_marker_frequency(marker = 'CD3', data = tmp, column='positive')
    tmp$cellType[tmp$cellType == 'CD4 T cells' & grepl('CD3\\-', tmp$CD3)] = NA
    data[[paste1(method, markers)]] = 
		data.table::as.data.table(cbind(tmp, method=method, markers=markers))
  }
}

if(! length(data)) {
	print('No data')
} else {
	
	# If the input was not generated by deep-imcyto
	if(! paste1('csm', args$major_markers) %in% names(data)) {
		data[[paste1('csm', args$major_markers)]] = data.frame(
				cellType = NA, positive = '', method = 'csm',
				markers=args$major_markers)
	}
	mrg = data.table::rbindlist(data, use.names = T, fill = T)
	# Exclude unassigned, esp from csm, so that there are not considered as false negatives
	mrg = mrg[!mrg$cellType %in% c('Excluded', 'Unassigned'), ]
	mrg$cellID = with(mrg, paste(object, imagename))
	mrg$centerX = round(mrg$centerX, 2)
	mrg$centerY = round(mrg$centerY, 2)

	# tranform for plotting
	for(feature in grepv("Intensity", features))
		mrg[, (feature) := lapply(.SD, 
			function(x) log2(to_magnitude(x, pars$magnitude) + 1)), 
			.SDcols=feature]

	recast <- data.table::dcast(mrg, 
		cellID + imagename + centerX + centerY + object ~ method + markers,
		value.var=c("cluster", "cellType", "positive", "meanIntensity"))
	
	# If the input was not generated by deep-imcyto
	if(all(is.na(recast[[csmCol]])))
		recast[[csmCol]] = 'None'
	# Those in csm that do not have any associated raw masks
	recast[is.na(recast[, markerSets[2]]), markerSets[2]] = 'None'
	
	imagenames = unique(recast$imagename)
	
	fullStats = recast[[typedCols[1]]] %>% table
	refStats = recast[[typedCols[2]]] %>% table

	mostLikelyCellTypes = c(
		names(fullStats)[order(fullStats, decreasing = T)][1],
		names(refStats)[order(refStats, decreasing = T)][1]
	)
	print(mostLikelyCellTypes)
	if(length(mostLikelyCellTypes) < 2) {
		stop(paste("ERROR: Please make sure that both models have run.",
					"If cached in an earlier run, one of the processes can be skipped."))
	}
	cat(mostLikelyCellTypes, '\n', file = log, append = T)
	
	# No cell-specific raw masks to be used to define positive controls
	refCellTypes=unique(recast[[typedCols[2]]])
	fullCellTypes=unique(recast[[typedCols[1]]])

	undefinedFullTypes = fullCellTypes[! fullCellTypes %in% c(refCellTypes, args$mostFreqCellType)]
	undefinedRefTypes = refCellTypes[! refCellTypes %in% c(fullCellTypes)]
	
	negativeIndices = setdiff(which(recast[[typedCols[1]]] != recast[[typedCols[2]]]),
							  which(recast[[typedCols[2]]] %in% undefinedRefTypes |
						 		recast[[typedCols[1]]] %in% c(args$mostFreqCellType) &
								recast[[typedCols[2]]] %in% c(args$dependentCell, dependentCellTypes)))
								
	table(recast[[typedCols[2]]][! recast[[typedCols[1]]] %in% refCellTypes]) %>% 
		sort %>% print
	negative = recast$cellID[negativeIndices]
	cat('Negative CellIDs: ', length(negative), '\n')
		
	posIndices = recast[[typedCols[2]]] == recast[[typedCols[1]]] &  
				 ! recast[[typedCols[1]]] %in% mostLikelyCellTypes[1]

	positiveExcludedIndices = recast[[typedCols[1]]] %in% c(args$mostFreqCellType) &
								recast[[typedCols[2]]] %in% c(args$dependentCell, mostLikelyCellTypes[2], dependentCellTypes)
	negativeExcludedIndices = recast[[typedCols[1]]] %in% c(args$mostFreqCellType) &
								! recast[[typedCols[2]]] %in% c(mostLikelyCellTypes[2], args$dependentCell, dependentCellTypes)
	
	if(mostLikelyCellTypes[2] == mostLikelyCellTypes[1]) {
		
		# If both models have the same most likley cell type [user-provided cell lineage for exclusion]
		mostFreqIndices = recast[[typedCols[2]]] == mostLikelyCellTypes[2] & recast[[typedCols[1]]] == mostLikelyCellTypes[2]
		excludedFreqIndices = recast[[typedCols[2]]] == mostLikelyCellTypes[2]  & recast[[typedCols[1]]] == args$mostFreqCellType
						
		intensityChange = with(recast, get(intensityColNameFull) - get(intensityColNameRef))
		intensityRefNonzero = recast[[intensityColNameRef]] > 0 & ! is.na(recast[[intensityColNameRef]]) 
		intensityFullNonzero =  recast[[intensityColNameFull]] > 0 & ! is.na(recast[[intensityColNameFull]]) 
		mostFreqNegativeCutoff = mean(intensityChange[intensityFullNonzero & mostFreqIndices], na.rm = T) + 
								 sd(intensityChange[intensityFullNonzero & mostFreqIndices], na.rm = T)
	 	negativeCutoff = qnorm(0.95, mean = mean(intensityChange[intensityFullNonzero], na.rm = T) ,
									sd = sd(intensityChange[intensityFullNonzero], na.rm = T)) 
		
		print(mostFreqNegativeCutoff)
		print(negativeCutoff)
		
		cat("Negative cutoff", negativeCutoff, '\n', file = log, append = T)
		
		# The intensities should not change significantly for the most common cell type
		nCut = min(recast[[intensityColNameFull]][intensityChange > negativeCutoff & 
												  intensityRefNonzero & 
												  excludedFreqIndices], na.rm = T)
		qCut = max(recast[[intensityColNameRef]][intensityChange > negativeCutoff & 
												 excludedFreqIndices], na.rm = T)
		cat(qCut, nCut, '\n')
	
		cols = unique(palette$cellTypeColors)
		colorCol = typedCols[1]
		pdfOut=f("{out}/MostFrequentSame.{analysisID}.pdf")
		pdf(pdfOut, width = 7, height = 4)
		# Skip plotting the full dataset if more than 0.5M cells
		if(nrow(recast) < 500000) {
			g <- ggplot(droplevels(recast), aes(get(intensityColNameFull), get(intensityColNameRef)))
			plot = g + geom_point(aes(color = get(colorCol)), size = 0.01) + 
				theme_classic() +
				geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
				geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
				ggtitle(mostLikelyCellTypes[1]) +
				theme(legend.text = element_text(size = 5))
			print(plot)	
		}		
			df = recast[mostFreqIndices, ] %>% droplevels
			g <- ggplot(df, aes(get(intensityColNameFull), get(intensityColNameRef)))
            plot = g + geom_point(aes(color = abs(get(intensityColNameFull) - get(intensityColNameRef)) <= mostFreqNegativeCutoff), size = 0.01) +
                theme_classic() +
                geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
				ggtitle(mostLikelyCellTypes[1]) +
				geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
				theme(legend.text = element_text(size = 5), legend.title = element_blank())
            print(plot)
			
			df = recast
			df$positive = NA
			df$positive[positiveExcludedIndices] = T
			df$negative[negativeExcludedIndices] = F
			
			df = df[excludedFreqIndices, ] %>% droplevels
			g <- ggplot(df, aes(get(intensityColNameFull), get(intensityColNameRef)))
            plot = g + geom_point(aes(color = positive), size = 0.01) +
                theme_classic() +
                geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
				ggtitle(args$mostFreqCellType) +
				geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
				theme(legend.text = element_text(size = 5), legend.title = element_blank())
            print(plot)

			dev.off()
			cat("Most likely cell type in full model equals the most likley cell type in the reference model",
				 "considering mean intensities: >", qCut, '\n', sep = ' ')
		
		posIndices = posIndices |
					recast[[typedCols[2]]] == mostLikelyCellTypes[2] & # Both models have mostLikelyCellTypes - no singificant change in intensity, & nonzero
					recast[[typedCols[1]]] == mostLikelyCellTypes[2] &
					abs(recast[[intensityColNameFull]] - recast[[intensityColNameRef]]) <= mostFreqNegativeCutoff &
					intensityRefNonzero
					
		positiveExcludedIndices = recast[[typedCols[1]]] %in% c(args$mostFreqCellType) & 
									recast[[intensityColNameFull]] > nCut &
      							  	recast[[intensityColNameRef]] <= qCut
	}
	positive = recast$cellID[which(posIndices)]
	cat('Positive CellIDs: ', length(positive), '\n')
	if(regionCol %in% colnames(recast))
		positive = union(positive,
			  			recast$cellID[which(recast[[regionCol]] == "Tumour" &
									  grepl("Epithelial cells|tumour cells|Epithelium", 
									  		recast[[typedCols[2]]], ignore.case = T))])
											
	print(table(recast[[typedCols[2]]][recast$cellID %in% positive]))

	colorCol = typedCols[1]
	if(args$mostFreqCellType == mostLikelyCellTypes[1]) {
			
		mostFreqIndices = recast[[typedCols[1]]] == mostLikelyCellTypes[1] & ! is.na(recast[[typedCols[1]]])
		intensityChange = with(recast, get(intensityColNameFull) - get(intensityColNameRef))
		intensityRefNonzero = recast[[intensityColNameRef]] > 0 & ! is.na(recast[[intensityColNameRef]]) 
		intensityFullNonzero =  recast[[intensityColNameFull]] > 0 & ! is.na(recast[[intensityColNameFull]]) 
		negativeCutoff = qnorm(0.95, mean = mean(intensityChange[intensityFullNonzero], na.rm = T) , 
									 sd = sd(intensityChange[intensityFullNonzero], na.rm = T)) 
		print(negativeCutoff)
		cat("Negative cutoff", negativeCutoff, '\n', file = log, append = T)

        nCut = min(recast[[intensityColNameFull]][intensityChange > negativeCutoff & 
													intensityRefNonzero & mostFreqIndices], na.rm = T)
		qCut = max(recast[[intensityColNameRef]][intensityChange > negativeCutoff & mostFreqIndices], na.rm = T)
		cat(qCut, nCut, '\n')
			 
		cols = unique(palette$cellTypeColors)
		pdfOut=f("{out}/MostFrequentExcluded.{analysisID}.pdf")
		pdf(pdfOut, width = 7, height = 4)
		# Skip plotting the full dataset if more than 0.5M cells
		if(nrow(recast) < 500000) {
			g <- ggplot(droplevels(recast), aes(get(intensityColNameFull), get(intensityColNameRef)))
			plot = g + geom_point(aes(color = get(colorCol)), size = 0.01) + 
				theme_classic() +
				geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
				geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
				ggtitle(mostLikelyCellTypes[1]) +
				theme(legend.text = element_text(size = 5))
			print(plot)

		}
		df = recast[mostFreqIndices, ] %>% droplevels
		g <- ggplot(df, aes(get(intensityColNameFull), get(intensityColNameRef)))
		plot = g + geom_point(aes(color = get(colorCol)), size = 0.01) + 
			theme_classic() +
			geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
			ggtitle(mostLikelyCellTypes[1]) +
			geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
			theme(legend.text = element_text(size = 5), legend.title = element_blank())
		print(plot)
		g <- ggplot(df, aes(get(intensityColNameFull), get(intensityColNameRef)))
        plot = g + geom_point(aes(color = get(colorCol)), size = 0.01) +
            theme_classic() +
            geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
            ggtitle(mostLikelyCellTypes[1]) +
            geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
            theme(legend.text = element_text(size = 5), legend.title = element_blank())
        print(plot)
	
		
		df = recast[mostFreqIndices, ] %>% droplevels
		g <- ggplot(df, aes(get(intensityColNameFull), get(intensityColNameRef)))
        plot = g + geom_point(aes(color = get(intensityColNameFull) - get(intensityColNameRef) > negativeCutoff), size = 0.01) +
            theme_classic() +
            geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
            geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
			ggtitle(mostLikelyCellTypes[1]) +
			theme(legend.text = element_text(size = 5), legend.title = element_blank())
        print(plot)

		df = recast[mostFreqIndices, ] %>% droplevels
		df$equal = df[[typedCols[2]]] != mostLikelyCellTypes[2]
		g <- ggplot(df, aes(get(intensityColNameFull) - get(intensityColNameRef)))
        plot = g + geom_density(aes(color = equal), size = 0.01) +
            theme_classic() +
			geom_vline(aes(xintercept = negativeCutoff), linetype = 'dashed') +
			ggtitle(mostLikelyCellTypes[1]) +
            theme(legend.text = element_text(size = 5), legend.title = element_blank())
        print(plot)
		dev.off()
		cat("Most likely cell type in full model equals the excluded cell type in the reference model",
			 "considering mean intensities: >", nCut, '\n', sep = ' ')
		
		
		positiveExcludedIndices = positiveExcludedIndices &
				recast[[intensityColNameFull]] > nCut &
                recast[[intensityColNameRef]] <= qCut
	}
		for(missedCellType in undefinedFullTypes) {
			
			print(missedCellType)
			cat("Missed cell type", missedCellType, '\n', file = log, append = T)
			# positiveCut 0.4, quantileCut .9
			mostFreqIndices = recast[[typedCols[1]]] == missedCellType & ! is.na(recast[[typedCols[1]]])
			intensityChange = with(recast, get(intensityColNameFull) - get(intensityColNameRef))
        	intensityRefNonzero = recast[[intensityColNameRef]] > 0 & ! is.na(recast[[intensityColNameRef]])
        	intensityFullNonzero =  recast[[intensityColNameFull]] > 0 & ! is.na(recast[[intensityColNameFull]])
        	negativeCutoff = mean(intensityChange[intensityFullNonzero], na.rm = T) +
                           		sd(intensityChange[intensityFullNonzero], na.rm = T)
        	print(negativeCutoff)
			cat("Negative cutoff", negativeCutoff, '\n', file = log, append = T)

	        nCut = min(recast[[intensityColNameFull]][intensityChange > negativeCutoff & intensityRefNonzero & mostFreqIndices], na.rm = T)
    	    qCut = max(recast[[intensityColNameRef]][intensityChange > negativeCutoff & mostFreqIndices], na.rm = T)
    	    cat(qCut, nCut, '\n')
				
			cols = unique(palette$cellTypeColors)
			pdfOut = f("{out}/Missing.{missedCellType}.{analysisID}.pdf")
			pdf(pdfOut, width = 6, height = 4)
			if(! nrow(recast) < 500000) {
			
				g <- ggplot(recast, aes(get(intensityColNameFull), get(intensityColNameRef)))
				plot = g + geom_point(aes(color = get(colorCol)), size = 0.01) + 
					theme_classic() +
					geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
					geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
					ggtitle(missedCellType) +
					theme(legend.text = element_text(size = 5))
				print(plot)

				g <- ggplot(recast[mostFreqIndices, ], aes(get(intensityColNameFull), get(intensityColNameRef)))
				plot = g + geom_point(aes(color = get(typedCols[2])), size = 0.01) + 
					theme_classic() +
					geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
					geom_hline(aes(yintercept = qCut), linetype= 'dashed') +
					ggtitle(missedCellType) +
					theme(legend.text = element_text(size = 5)) +
					geom_hline(aes(yintercept = nCut), linetype= 'dotted')
				print(plot)
			}
				print('Intensity')
				df = recast[mostFreqIndices, ] %>% droplevels
				df$color = df[[intensityColNameFull]] - df[[intensityColNameRef]] > negativeCutoff
				print(table(df$color))
				g <- ggplot(df, aes(get(intensityColNameFull), get(intensityColNameRef)))
				plot = g + geom_point(aes(color = get(intensityColNameFull) - get(intensityColNameRef) > negativeCutoff), size = 0.01) +
					theme_classic() +
					geom_vline(aes(xintercept = nCut), linetype= 'dotted') +
					geom_hline(aes(yintercept = qCut), linetype= 'dotted') +
					ggtitle(missedCellType) +
					theme(legend.text = element_text(size = 5), legend.title = element_blank())
				print(plot)


			df = recast[mostFreqIndices, ] %>% droplevels
        	df$equal = df[[typedCols[2]]] != missedCellType
        	g <- ggplot(df, aes(get(intensityColNameFull) - get(intensityColNameRef)))
        	plot = g + geom_density(aes(color = equal), size = 0.01) +
            	theme_classic() +
        	    geom_vline(aes(xintercept = negativeCutoff), linetype = 'dashed') +
    	        ggtitle(mostLikelyCellTypes[1]) +
	            theme(legend.text = element_text(size = 5), legend.title = element_blank())
            print(plot)
			dev.off()

			cat('Missing cell type in ref model ', missedCellType,
				'considering mean intensities: ', nCut, '\n', sep = ' ')

			positiveExcludedIndices=positiveExcludedIndices |
				recast[[typedCols[1]]] %in% missedCellType &
				recast[[intensityColNameFull]] > nCut & 
				recast[[intensityColNameRef]] <= qCut

			negativeExcludedIndices = negativeExcludedIndices | 
					recast[[typedCols[1]]] %in% missedCellType &
						recast[[intensityColNameFull]] <= qCut
		}
		
		positiveExcluded=recast$cellID[positiveExcludedIndices]
		cat('Positive mostFreqCellType CellIDs: ', length(positiveExcluded), '\n')
		
		negativeExcluded=recast$cellID[negativeExcludedIndices]
		cat('Neg mostFreqCellType CellIDs: ', length(negativeExcluded), '\n')
 	}
	totalExcludedCell=mrg$markers==args$major_markers & 
		mrg$method == args$major_method &
		! is.na(mrg$probability) &
		mrg$cellType %in% c(args$mostFreqCellType, undefinedFullTypes)

	posExcludedIndices = mrg$cellID %in% positiveExcluded & totalExcludedCell
	negExcludedIndices = mrg$cellID %in% negativeExcluded & totalExcludedCell
	
	print('Negative')
	paste(recast[[typedCols[1]]][recast$cellID %in% negative],
			recast[[typedCols[2]]][recast$cellID %in% negative]) %>%
						   		table %>% sort %>% print
	print('Positive')
	paste(recast[[typedCols[1]]][recast$cellID %in% positive],
			recast[[typedCols[2]]][recast$cellID %in% positive]) %>% 
						   table %>% sort %>% print

	mrg$control="undetermined"
	mrg$control[which(mrg$cellID %in% negative)] = "negative"
	mrg$control[which(mrg$cellID %in% positive)] = "positive"
	mrg$control[totalExcludedCell]="undetermined"
	mrg$control[negExcludedIndices]="negative"
	mrg$control[posExcludedIndices]="positive"
	mrg$cellType[posExcludedIndices] %>% table
		
	# Predict positive and negative cell objects
	controlCellIDs = mrg$control %in% c("positive", "negative") &
	  mrg$markers == ref_markers_list & 
	  mrg$method == args$major_method &
	  ! is.na(mrg$probability)
	cat('Control CellIDs', length(controlCellIDs), '\n')
	cat('Positive mostFreqCellType CellIDs: ', length(posExcludedIndices), '\n')
	cat('Negative mostFreqCellType CellIDs: ', length(negExcludedIndices), '\n')
	print('Probability')
	print(table(mrg$cellType[ is.na(mrg$probability &
			    mrg$method == args$major_method)]))
	
	dfFlt = mrg[controlCellIDs | posExcludedIndices | negExcludedIndices, ]
	dfFlt$control = sapply(dfFlt$control == "positive", sum)

	print(with(dfFlt, table(control, cellType, markers)))	
	# Model on selected covariates
	
	cat('Creating model with', '\n', file = log, append = T)
	cntrStat = with(dfFlt, table(control, cellType, markers))
	write.table(cntrStat, file = log, append = T, sep = '\t',
					row.names = F)
	nrControls = length(unique(dfFlt$control[! is.na(dfFlt$control)]))
	if(nrControls < 2)
		stop('Cannot create a model with', nrControls, 'control values.')
	
	nrInt = sum(is.na(dfFlt$meanIntensity))
    if(nrInt > 0)
        stop(f('ERROR: Intensity values missing for {nrInt} cells. ', 
				'Cannot create a model with NAs for the following cell types:', 
			table(dfFlt$cellType[is.na(dfFlt$meanIntensity)]), 
			'Please make sure the cell type definition file has not changed from an earlier first run or indicate a new release.'))
	
	print('Creating model with')
	print(with(dfFlt, table(control, cellType, markers)))
	print(range(dfFlt$probability))
	print(range(dfFlt$meanIntensity))
	model <- lme4::glmer(as.formula(f("control ~ probability + meanIntensity +
		                                (1|cellType)")), data = dfFlt, 
										family = binomial)
	print("Comparing predicted vs controls")
	predict = predict(model, newdata = dfFlt, type = "response", allow.new.levels =T)
	ROCRpred <- ROCR::prediction(predict[! is.na(predict)], dfFlt$control[! is.na(predict)])
	sensit = ROCR::performance(ROCRpred, 'sens')
	specif = ROCR::performance(ROCRpred, 'spec')
	# cat(sensit, specif, "\n")
	modelCutoff = sensit@x.values[[1]][which.min(abs(sensit@y.values[[1]] - specif@y.values[[1]]))]
	cat('Model cutoff: ', modelCutoff, "\n")
	save(modelCutoff, model, file = modelOut)
	sensDf <- data.frame(x=unlist(sensit@x.values), y=unlist(sensit@y.values))
	specDf <- data.frame(x=unlist(specif@x.values), y=unlist(specif@y.values))
	pdf(f("{out}/Model.{analysisID}.pdf"), height=3, width=4)
	plot = sensDf %>% ggplot(aes(x,y)) +
		geom_line() +
		geom_line(data=specDf, aes(x,y,col="red")) +
		scale_y_continuous(sec.axis = sec_axis(~., name = "Specificity")) +
		labs(x='Cutoff', y="Sensitivity") +
		theme(axis.title.y.right = element_text(colour = "red"), legend.position="none") +
		geom_vline(aes(xintercept=modelCutoff), linetype="dashed") +
		guides(color='none') +
		cowplot::theme_cowplot()
	print(plot)
	dev.off()

	dfMrg = droplevels(mrg[mrg$method == args$major_method & 
		mrg$markers == ref_markers_list |
		posExcludedIndices | negExcludedIndices, ])
	print("Predicting low and high confidence based on the binomial model")
	cat('Predicting low and high confidence based on the binomial model on ', 
		nrow(dfMrg), ' objects', file = log, append = T)
	
	predictProb = predict(model, newdata = droplevels(dfMrg), type = "response", allow.new.levels=T)
	print(summary(predictProb))
	dfMrg$predicted=predictProb > modelCutoff
	#dfMrg$predicted=ifelse(mrg$predicted, "positive", "negative")
	print(table(dfMrg$predicted, dfMrg$cellType))
	
	cat("Predicted\n", file = log, append = T)
	predStat = table(dfMrg$predicted, dfMrg$cellType)
	write.table(predStat, append = T, quote = F, row.names = T, file = log)
	stats=data.frame(table(dfMrg$control))
	stats$Freq=round(stats$Freq/sum(stats$Freq), 3)
	stats$Var1=factor(stats$Var1, levels=sort(stats$Var1))
	
	if("cellTypingStatusCols" %in% names(palette)) 
		stop("ERROR message: cellTypingStatusCols missing. Confirm it hasn't been removed from the celltype_colors.json file."
	pdfOut=f("{out}/Control_stats.{analysisID}.pdf")
	pdf(pdfOut, height=5, width=5)
	g <- ggplot(stats, aes(x="", y=Freq, fill=Var1))
	plot=g + geom_bar(stat="identity") + theme_classic(base_size=18) +
	  scale_fill_manual(name="Cell type controls", 
	                    values=palette$cellTypingStatusCols,
	                    labels=paste0(levels(stats$Var1), " (", 
	                                  stats$Freq[match(levels(stats$Var1), stats$Var1)] * 100, "%)")) +
	  coord_polar(theta="y", start=0, direction=-1) +
	  theme(axis.line=element_blank(),
	        axis.text= element_blank(),
	        axis.ticks=element_blank()) +
	  xlab("") + ylab("")
	  # scale_y_continuous(labels=function(x) paste0(x * 100, "%"))
	print(plot)

	predStats=data.table(table(dfMrg$control, dfMrg$predicted))
	predStats$Freq = sapply(1:nrow(predStats),  function(x) 
	  round(predStats$N[x] / sum(predStats$N[predStats$V1 == predStats$V1[x]]), 3))
	print(head(predStats))
	predStats = predStats[predStats$N > 0, ]
	predStats$V1 = factor(predStats$V1, levels=unique(sort(predStats$V1)))
	print(head(predStats))
	g <- ggplot(predStats, aes(x="", y=Freq))
	plot = g + geom_bar(stat="identity",fill = "lightblue", color="black" ) +
	  theme_classic(base_size=18) +
	  facet_grid(. ~ V1) +
	  coord_polar(theta="y", start=0, direction=-1) +
	  theme(axis.line=element_blank(), axis.ticks=element_blank(), 
	        axis.text=element_blank()) +
	  xlab("") + ylab("") +
	  scale_y_continuous(limits = c(0, 1))
	print(plot)

	cellStats = data.table(table(dfMrg$control, dfMrg$cellType))
	cellStats$Freq = sapply(1:nrow(cellStats), function(x) with(cellStats, round(N[x]/sum(N[V1 == V1[x]]), 3)))
	cellTypeColors=palette$cellTypeColors[names(palette$cellTypeColors) %in% cellStats$V2]
	
	cellStats$V1 = factor(cellStats$V1, levels = unique(sort(cellStats$V1)))
	cellStats$V2 = factor(cellStats$V2, levels = names(cellTypeColors))
	g <- ggplot(cellStats, aes(x = V1, y = Freq, fill = V2))
	plot=g + geom_bar(stat = "identity", color = "black" ) +
	  theme_classic(base_size = 18) +
	  theme(axis.line = element_blank(), axis.ticks=element_blank(), 
	        axis.text.x = element_text(angle=45)) +
	  xlab("") + ylab("") +
	  scale_fill_manual(values=cellTypeColors) +
	  guides(fill = guide_legend(title='Cell type'))
	print(plot)
	dev.off()
	cat('CHECK:', pdfOut, "\n")

	pdfOut=f("{out}/Control_comparison.{analysisID}.pdf")
	pdf(pdfOut, height=4)
	for(feature in features) {
		cat('Plotting ', feature , '\n')

	  dfFlt=droplevels(dfMrg[dfMrg$method == args$major_method &
		  					dfMrg$markers == ref_markers_list |
							dfMrg$cellType %in% c(args$mostFreqCellType, undefinedFullTypes) &
							dfMrg$markers == args$major_markers, ]
	  )
	  if(! feature %in% colnames(dfFlt)) {
		  cat('Skipping', feature, ': not in data frame.\n')
	  }

	  if(all(is.na(dfFlt[[feature]]))) {
		  cat('Skipping', feature, ': all values undefined.\n')
		  next
	  }
		 
	  cat(feature, nrow(dfFlt), "\n")
	  cellTypeStats = table(dfFlt$cellType)
	  g <- ggplot(dfFlt)
	  plot = g + 
	  	cowplot::theme_cowplot(font_size = 14) + # ggtitle(feature) +
	    theme(axis.text.x = element_text(angle=45, hjust = 1),
	          legend.position = "top") +
	    guides(fill = guide_legend(nrow = length(unique(dfFlt$method)))) +
	    xlab(NULL)
	    if(feature=="Probability")
	        plot = plot + geom_hline(aes(yintercept=0.5), linetype="dashed", color="grey")
	    if(feature == "area")
	      plot = plot + scale_y_log10()
	  plot1 = plot + geom_boxplot(aes(cellType, get(feature), fill=control), outlier.size = 0.05) +
	    scale_fill_manual(values = palette$cellTypingStatusCols)
		print(feature)
		print(palette$cellTypingStatusCols)
	  print(plot1)	  	  
	  plot2 = plot + geom_boxplot(data=droplevels(subset(dfFlt, ! is.na(predicted))),
	                            aes(cellType, get(feature), fill = predicted)) +
	    facet_grid( . ~ control)
	  print(plot2)
	dev.off()
	cat('CHECK:', pdfOut, "\n")
}
